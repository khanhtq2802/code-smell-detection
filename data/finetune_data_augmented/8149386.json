{"text": "<fim_prefix>/*\n * Copyright 1999-2012 Alibaba Group.\n *  \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *  \n *      http://www.apache.org/licenses/LICENSE-2.0\n *  \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.alibaba.cobar.manager.response;\n\nimport java.util.Map;\n\nimport org.apache.log4j.Logger;\n\nimport com.alibaba.cobar.CobarServer;\nimport com.alibaba.cobar.manager.ManagerConnection;\nimport com.alibaba.cobar.manager.parser.ManagerParseStop;\nimport com.alibaba.cobar.mysql.MySQLDataNode;\nimport com.alibaba.cobar.net.mysql.OkPacket;\nimport com.alibaba.cobar.parser.util.Pair;\nimport com.alibaba.cobar.util.FormatUtil;\nimport com.alibaba.cobar.util.TimeUtil;\n\n/**\n * \u6682\u505c\u6570\u636e\u8282\u70b9\u5fc3\u8df3\u68c0\u6d4b\n * \n * @author xianmao.hexm\n */\n<fim_suffix>public final class StopHeartbeat {\n\n    private static final Logger logger = Logger.getLogger(StopHeartbeat.class);\n\n    public static void execute(String stmt, ManagerConnection c) {\n        int count = 0;\n        Pair<String[], Integer> keys = ManagerParseStop.getPair(stmt);\n        if (keys.getKey() != null && keys.getValue() != null) {\n            long time = keys.getValue().intValue() * 1000L;\n            Map<String, MySQLDataNode> dns = CobarServer.getInstance().getConfig().getDataNodes();\n            for (String key : keys.getKey()) {\n                MySQLDataNode dn = dns.get(key);\n                if (dn != null) {\n                    dn.setHeartbeatRecoveryTime(TimeUtil.currentTimeMillis() + time);\n                    ++count;\n                    StringBuilder s = new StringBuilder();\n                    s.append(dn.getName()).append(\" stop heartbeat '\");\n                    logger.warn(s.append(FormatUtil.formatTime(time, 3)).append(\"' by manager.\"));\n                }\n            }\n        }\n        OkPacket packet = new OkPacket();\n        packet.packetId = 1;\n        packet.affectedRows = count;\n        packet.serverStatus = 2;\n        packet.write(c);\n    }\n\n}<fim_middle>// class below has no smell\n"}