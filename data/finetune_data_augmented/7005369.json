{"text": "<fim_prefix>// Copyright 2017 The Nomulus Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\npackage google.registry.tmch;\nimport static com.google.common.base.MoreObjects.toStringHelper;\nimport static com.google.common.base.Preconditions.checkArgument;\nimport static com.google.common.base.Preconditions.checkNotNull;\nimport com.google.common.base.Ascii;\nimport com.google.common.base.Splitter;\nimport com.google.common.collect.ImmutableMap;\nimport com.google.re2j.Pattern;\nimport java.util.Iterator;\nimport java.util.List;\nimport java.util.Map.Entry;\nimport javax.annotation.Nullable;\nimport javax.annotation.concurrent.Immutable;\nimport org.joda.time.DateTime;\n/**\n * Parser of LORDN log responses from the MarksDB server during the NORDN process.\n *\n * @see <a href=\"http://tools.ietf.org/html/draft-lozano-tmch-func-spec-08#section-6.3.1\">\n *     TMCH functional specifications - LORDN Log File</a>\n */\n@Immutable\npublic final class LordnLog implements Iterable<Entry<String, LordnLog.Result>> {\n  /** Indicates whether or not the LORDN upload succeeded. */\n  public enum Status { ACCEPTED, REJECTED }\n  /** Result code for individual DN lines. */\n<fim_suffix>  @Immutable\n  public static final class Result {\n    /** Outcome categories for individual DN lines. */\n    public enum Outcome { OK, WARNING, ERROR }\n    private final int code;\n    private final String description;\n    private final Outcome outcome;\n    private Result(int code, String description) {\n      this.code = code;\n      this.description = description;\n      if (2000 <= code && code <= 2099) {\n        this.outcome = Outcome.OK;\n      } else if (3500 <= code && code <= 3699) {\n        this.outcome = Outcome.WARNING;\n      } else if (4500 <= code && code <= 4699) {\n        this.outcome = Outcome.ERROR;\n      } else {\n        throw new IllegalArgumentException(\"Invalid DN result code: \" + code);\n      }\n    }\n    public int getCode() {\n      return code;\n    }\n    public String getDescription() {\n      return description;\n    }\n    public Outcome getOutcome() {\n      return outcome;\n    }\n    @Override\n    public String toString() {\n      return toStringHelper(this)\n          .add(\"code\", code)\n          .add(\"outcome\", outcome)\n          .add(\"description\", description)\n          .toString();\n    }\n  }\n  private static final ImmutableMap<Integer, Result> RESULTS =\n      new ImmutableMap.Builder<Integer, Result>()\n          .put(2000, new Result(2000, \"OK\"))\n          .put(2001, new Result(2001, \"OK but not processed\"))\n          .put(3601, new Result(3601, \"TCN Acceptance Date after Registration Date\"))\n          .put(3602, new Result(3602, \"Duplicate DN Line\"))\n          .put(3603, new Result(3603, \"DNROID Notified Earlier\"))\n          .put(3604, new Result(3604, \"TCN Checksum invalid\"))\n          .put(3605, new Result(3605, \"TCN Expired\"))\n          .put(3606, new Result(3606, \"Wrong TCNID used\"))\n          .put(3609, new Result(3609, \"Invalid SMD used\"))\n          .put(3610, new Result(3610, \"DN reported outside of the time window\"))\n          .put(3611, new Result(3611, \"DN does not match the labels in SMD\"))\n          .put(3612, new Result(3612, \"SMDID does not exist\"))\n          .put(3613, new Result(3613, \"SMD was revoked when used\"))\n          .put(3614, new Result(3614, \"TCNID does not exist\"))\n          .put(3615, new Result(3615, \"Recent-dnl-insertion outside of the time window\"))\n          .put(\n              3616, new Result(3616, \"Registration Date of DN in claims before the end of Sunrise\"))\n          .put(3617, new Result(3617, \"Registrar has not been approved by the TMDB\"))\n          .put(3618, new Result(3618, \"Registration Date of DN outside of QLP period\"))\n          .put(3619, new Result(3619, \"TCN was not valid at the time of acknowledgement\"))\n          .put(4501, new Result(4501, \"Syntax Error in DN Line\"))\n          .put(4601, new Result(4601, \"Invalid TLD used\"))\n          .put(4602, new Result(4602, \"Registrar ID Invalid\"))\n          .put(4603, new Result(4603, \"Registration Date in the future\"))\n          .put(4606, new Result(4606, \"TLD not in Sunrise or Claims\"))\n          .put(4607, new Result(4607, \"Application Date in the future\"))\n          .put(4608, new Result(4608, \"Application Date is later than Registration Date\"))\n          .put(4609, new Result(4609, \"TCNID wrong syntax\"))\n          .put(4610, new Result(4610, \"TCN Acceptance Date is in the future\"))\n          .put(4611, new Result(4611, \"Label has never existed in the TMDB\"))\n          .build();\n  /** Base64 matcher between one and sixty characters. */\n  private static final Pattern LOG_ID_PATTERN = Pattern.compile(\"[-A-Za-z0-9+/=]{1,60}\");\n  private final String logId;\n  private final Status status;\n  private final DateTime logCreation;\n  private final DateTime lordnCreation;\n  private final boolean hasWarnings;\n  private final ImmutableMap<String, Result> results;\n  private LordnLog(\n      String logId,\n      Status status,\n      DateTime logCreation,\n      DateTime lordnCreation,\n      boolean hasWarnings,\n      ImmutableMap<String, Result> results) {\n    this.logId = logId;\n    this.status = status;\n    this.logCreation = logCreation;\n    this.lordnCreation = lordnCreation;\n    this.hasWarnings = hasWarnings;\n    this.results = results;\n  }\n  public String getLogId() {\n    return logId;\n  }\n  public Status getStatus() {\n    return status;\n  }\n  public DateTime getLogCreation() {\n    return logCreation;\n  }\n  public DateTime getLordnCreation() {\n    return lordnCreation;\n  }\n  public boolean hasWarnings() {\n    return hasWarnings;\n  }\n  @Nullable\n  public Result getResult(String roid) {\n    return results.get(roid);\n  }\n  @Override\n  public Iterator<Entry<String, Result>> iterator() {\n    return results.entrySet().iterator();\n  }\n  @Override\n  public String toString() {\n    return toStringHelper(this)\n        .add(\"logId\", logId)\n        .add(\"status\", status)\n        .add(\"logCreation\", logCreation)\n        .add(\"lordnCreation\", lordnCreation)\n        .add(\"hasWarnings\", hasWarnings)\n        .add(\"results\", results)\n        .toString();\n  }\n  /** Turns lines of NORDN log returned by MarksDB into a data structure. */\n  public static LordnLog parse(List<String> lines) {\n    // First line: <version>,<LORDN Log creation datetime>,<LORDN file creation datetime>,\n    //             <LORDN Log Identifier>,<Status flag>,<Warning flag>,<Number of DN Lines>\n    List<String> firstLine = Splitter.on(',').splitToList(lines.get(0));\n    checkArgument(firstLine.size() == 7, String.format(<fim_middle>// class below is data class\n"}