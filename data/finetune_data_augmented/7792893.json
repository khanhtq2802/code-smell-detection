{"text": "<fim_prefix>import org.apache.wicket.util.resource.IResourceStream;\nimport org.apache.wicket.util.resource.StringResourceStream;\nimport org.apache.wicket.util.time.Duration;\n/**\n * Ajax download.\n * \n * @author svenmeier\n */\npublic class AjaxDownloadPage extends BasePage\n{\n\tprivate WebMarkupContainer downloadingContainer;\n\t/**\n\t * Constructor\n\t */\n\tpublic AjaxDownloadPage()\n\t{\n\t\tdownloadingContainer = new WebMarkupContainer(\"downloading\");\n\t\tdownloadingContainer.setOutputMarkupPlaceholderTag(true);\n\t\tdownloadingContainer.setVisible(false);\n\t\tadd(downloadingContainer);\n\t\tinitDownload();\n\t\tinitDownloadInIframe();\n\t\tinitDownloadInNewWindow();\n\t\tinitDownloadInSameWindow();\n\t\tinitDownloadReference();\n\t}\n\t@Override\n\tprotected void onConfigure()\n\t{\n\t\tsuper.onConfigure();\n\t\t// download cannot continue on page refresh\n\t\tdownloadingContainer.setVisible(false);\n\t}\n\tprivate void initDownload()\n\t{\n\t\tIResource resource = new ExampleResource(\"downloaded via ajax\")\n\t\t\t.setContentDisposition(ContentDisposition.ATTACHMENT);\n\t\tfinal AjaxDownloadBehavior download = new AjaxDownloadBehavior(resource) {\n\t\t\t@Override\n\t\t\tprotected void onBeforeDownload(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(true);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t}\n\t\t\t@Override\n\t\t\tprotected void onDownloadSuccess(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(false);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t}\n\t\t\t@Override\n\t\t\tprotected void onDownloadFailed(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(false);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t\ttarget.appendJavaScript(\"alert('Download failed');\");\n\t\t\t}\n\t\t};\n\t\tadd(download);\n\t\tadd(new AjaxLink<Void>(\"download\")\n\t\t{\n\t\t\t@Override\n\t\t\tpublic void onClick(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownload.initiate(target);\n\t\t\t}\n\t\t});\n\t}\n\tprivate void initDownloadInIframe()\n\t{\n\t\tIResource resource = new ExampleResource(\"downloaded via ajax in iframe\")\n\t\t\t.setContentDisposition(ContentDisposition.ATTACHMENT);\n\t\tfinal AjaxDownloadBehavior download = new AjaxDownloadBehavior(resource) {\n\t\t\t@Override\n\t\t\tprotected void onBeforeDownload(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(true);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t}\n\t\t\t@Override\n\t\t\tprotected void onDownloadSuccess(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(false);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t}\n\t\t\t@Override\n\t\t\tprotected void onDownloadFailed(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(false);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t\ttarget.appendJavaScript(\"alert('Download failed');\");\n\t\t\t}\n\t\t};\n\t\tdownload.setLocation(Location.IFrame);\n\t\tadd(download);\n\t\tadd(new AjaxLink<Void>(\"downloadIframe\")\n\t\t{\n\t\t\t@Override\n\t\t\tpublic void onClick(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownload.initiate(target);\n\t\t\t}\n\t\t});\n\t}\n\tprivate void initDownloadReference()\n\t{\n\t\tResourceReference reference = new ResourceReference(\"referenceToResource\") {\n\t\t\t@Override\n\t\t\tpublic IResource getResource()\n\t\t\t{\n\t\t\t\treturn new StaticResource();\n\t\t\t}\n\t\t};\n\t\tfinal AjaxDownloadBehavior download = new AjaxDownloadBehavior(reference) {\n\t\t\t@Override\n\t\t\tprotected void onBeforeDownload(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(true);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t}\n\t\t\t@Override\n\t\t\tprotected void onDownloadSuccess(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(false);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t}\n\t\t\t@Override\n\t\t\tprotected void onDownloadFailed(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(false);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t\ttarget.appendJavaScript(\"alert('Download failed');\");\n\t\t\t}\n\t\t};\n\t\tadd(download);\n\t\tadd(new AjaxLink<Void>(\"downloadReference\")\n\t\t{\n\t\t\t@Override\n\t\t\tpublic void onClick(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownload.initiate(target);\n\t\t\t}\n\t\t});\n\t}\n\tprivate void initDownloadInNewWindow()\n\t{\n\t\tIResource resource = new ExampleResource(\"downloaded via ajax in a new browser window\")\n\t\t\t.setContentDisposition(ContentDisposition.INLINE);\n\t\tfinal AjaxDownloadBehavior download = new AjaxDownloadBehavior(resource) {\n\t\t\t@Override\n\t\t\tprotected void onBeforeDownload(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(true);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t}\n\t\t\t@Override\n\t\t\tprotected void onDownloadSuccess(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(false);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t}\n\t\t\t@Override\n\t\t\tprotected void onDownloadFailed(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(false);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t\ttarget.appendJavaScript(\"alert('Download failed');\");\n\t\t\t}\n\t\t\t@Override\n\t\t\tprotected void onDownloadCompleted(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(false);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t}\n\t\t};\n\t\tdownload.setLocation(AjaxDownloadBehavior.Location.NewWindow);\n\t\tadd(download);\n\t\tadd(new AjaxLink<Void>(\"downloadInNewWindow\")\n\t\t{\n\t\t\t@Override\n\t\t\tpublic void onClick(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownload.initiate(target);\n\t\t\t}\n\t\t});\n\t}\n\tprivate void initDownloadInSameWindow()\n\t{\n\t\tIResource resource = new ExampleResource(\"downloaded via ajax in same browser window\")\n\t\t\t.setContentDisposition(ContentDisposition.ATTACHMENT);\n\t\tfinal AjaxDownloadBehavior download = new AjaxDownloadBehavior(resource) {\n\t\t\t@Override\n\t\t\tprotected void onBeforeDownload(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(true);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t}\n\t\t\t@Override\n\t\t\tprotected void onDownloadSuccess(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(false);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t}\n\t\t\t@Override\n\t\t\tprotected void onDownloadFailed(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(false);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t\ttarget.appendJavaScript(\"alert('Download failed');\");\n\t\t\t}\n\t\t\t@Override\n\t\t\tprotected void onDownloadCompleted(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownloadingContainer.setVisible(false);\n\t\t\t\ttarget.add(downloadingContainer);\n\t\t\t}\n\t\t};\n\t\tdownload.setLocation(AjaxDownloadBehavior.Location.SameWindow);\n\t\tadd(download);\n\t\tadd(new AjaxLink<Void>(\"downloadInSameWindow\")\n\t\t{\n\t\t\t@Override\n\t\t\tpublic void onClick(AjaxRequestTarget target)\n\t\t\t{\n\t\t\t\tdownload.initiate(target);\n\t\t\t}\n\t\t});\n\t}\n\tpublic static class StaticResource extends ResourceStreamResource {\n\t\tStaticResource() {\n\t\t\tsetFileName(\"File-from-ResourceReference\");\n\t\t\tsetContentDisposition(ContentDisposition.ATTACHMENT);\n\t\t\tsetCacheDuration(Duration.NONE);\n\t\t}\n\t\t@Override\n\t\tpublic void respond(Attributes attributes)\n\t\t{\n\t\t\tAjaxDownloadBehavior.markCompleted(attributes);\n\t\t\tsuper.respond(attributes);\n\t\t}\n\t\t@Override\n\t\tprotected IResourceStream getResourceStream(Attributes attributes)\n\t\t{\n\t\t\t// simulate delay\n\t\t\ttry\n\t\t\t{\n\t\t\t\tTimeUnit.MILLISECONDS.sleep(5000);\n\t\t\t}\n\t\t\tcatch (InterruptedException e)\n\t\t\t{\n\t\t\t}\n\t\t\treturn new StringResourceStream(\"downloaded via ajax with resource reference\");\n\t\t}\n\t}\n<fim_suffix>\tprivate class ExampleResource extends ResourceStreamResource {\n\t\tprivate String content;\n\t\tprivate int count = 0;\n\t\tpublic ExampleResource(String content)\n\t\t{\n\t\t\tthis.content = content;\n\t\t\tsetFileName(\"File-from-IResource.txt\");\n\t\t\tsetCacheDuration(Duration.NONE);\n\t\t}\n\t\t@Override\n\t\tprotected IResourceStream getResourceStream(Attributes attributes) {\n\t\t\t// simulate delay\n\t\t\ttry\n\t\t\t{\n\t\t\t\tTimeUnit.MILLISECONDS.sleep(3000);\n\t\t\t}\n\t\t\tcatch (InterruptedException e)\n\t\t\t{\n\t\t\t}\n\t\t\tcount++;\n\t\t\tif (count == 3) {\n\t\t\t\tcount = 0;\n\t\t\t\tthrow new AbortWithHttpErrorCodeException(400);\n\t\t\t}\n\t\t\treturn new StringResourceStream(content);\n\t\t};\n\t}<fim_middle>// class below has no smell\n"}