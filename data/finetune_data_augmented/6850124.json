{"text": "<fim_prefix>/*\nCopyright 2011-2016 Google Inc. All Rights Reserved.\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n    http://www.apache.org/licenses/LICENSE-2.0\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\npackage com.google.security.zynamics.binnavi.yfileswrap.Gui.GraphWindows;\nimport com.google.common.base.Preconditions;\nimport com.google.security.zynamics.binnavi.Gui.GraphWindows.CGraphModel;\nimport com.google.security.zynamics.binnavi.Gui.GraphWindows.Extensions.ICodeNodeExtension;\nimport com.google.security.zynamics.binnavi.Gui.GraphWindows.Implementations.CNodeHoverer;\nimport com.google.security.zynamics.binnavi.Gui.GraphWindows.Menu.CGraphWindowMenuBar;\nimport com.google.security.zynamics.binnavi.ZyGraph.Implementations.CProximityFunctions;\nimport com.google.security.zynamics.binnavi.ZyGraph.Menus.CEdgeMenu;\nimport com.google.security.zynamics.binnavi.ZyGraph.Menus.CProximityNodeMenu;\nimport com.google.security.zynamics.binnavi.ZyGraph.Updaters.CNodeUpdaterInitializer;\nimport com.google.security.zynamics.binnavi.disassembly.INaviViewNode;\nimport com.google.security.zynamics.binnavi.disassembly.views.CViewListenerAdapter;\nimport com.google.security.zynamics.binnavi.disassembly.views.INaviView;\nimport com.google.security.zynamics.binnavi.yfileswrap.zygraph.NaviEdge;\nimport com.google.security.zynamics.binnavi.yfileswrap.zygraph.NaviGraphListenerAdapter;\nimport com.google.security.zynamics.binnavi.yfileswrap.zygraph.NaviNode;\nimport com.google.security.zynamics.binnavi.yfileswrap.zygraph.ZyGraph;\nimport com.google.security.zynamics.zylib.yfileswrap.gui.zygraph.proximity.ZyProximityNode;\nimport java.awt.event.MouseEvent;\nimport java.util.ArrayList;\nimport java.util.List;\nimport javax.swing.JPopupMenu;\n/**\n * Synchronizes events in graph and view objects with the displayed graph.\n */\npublic final class CGraphPanelSynchronizer {\n  /**\n   * Model of the displayed graph.\n   */\n  private final CGraphModel m_model;\n  /**\n   * Graph-specific menu bar that is shown when the graph is active.\n   */\n  private final CGraphWindowMenuBar m_menuBar;\n  /**\n   * Handles clicks on nodes.\n   */\n  private final CNodeClickHandler m_clickHandler;\n  /**\n   * Updates the displayed graph on relevant changes in the underlying view object.\n   */\n  private final InternalViewListener m_viewListener = new InternalViewListener();\n  /**\n   * Updates the displayed graph on relevant changes in the graph.\n   */\n  private final InternalGraphListener m_graphListener = new InternalGraphListener();\n  /**\n   * Flag that indicates whether the graph panel has requested the view to be closed or not.\n   */\n  private boolean closing = false;\n  /**\n   * Extension objects that add menu items to the context menu of code nodes.\n   */\n  private final List<ICodeNodeExtension> m_codeNodeExtensions = new ArrayList<>();\n  /**\n   * Creates a new synchronizer object.\n   * \n   * @param model Model of the displayed graph.\n   * @param menuBar Graph-specific menu bar that is shown when the graph is active.\n   */\n<fim_suffix>  public CGraphPanelSynchronizer(final CGraphModel model, final CGraphWindowMenuBar menuBar) {\n    m_model = Preconditions.checkNotNull(model, \"IE01618: Model argument can not be null\");\n    m_menuBar = Preconditions.checkNotNull(menuBar, \"IE01620: Menu bar argument can not be null\");\n    m_clickHandler = new CNodeClickHandler(model);\n    m_model.getGraph().addListener(m_graphListener);\n    m_model.getGraph().getRawView().addListener(m_viewListener);\n  }\n  /**\n   * Frees allocated resources.\n   */\n  public void dispose() {\n    closing = true;\n    m_model.getGraph().getRawView().removeListener(m_viewListener);\n    m_model.getGraph().removeListener(m_graphListener);\n  }\n  /**\n   * Adds a new extension object that adds entries to the context menu of code nodes.\n   * \n   * @param extension The extension object to add.\n   */\n  public void registerCodeNodeContextMenuExtension(final ICodeNodeExtension extension) {\n    Preconditions.checkNotNull(extension, \"IE01621: Extension argument can not be null\");\n    m_codeNodeExtensions.add(extension);\n  }\n  /**\n   * Updates the displayed graph on relevant changes in the graph.\n   */\n  private class InternalGraphListener extends NaviGraphListenerAdapter {\n    /**\n     * Highlights lines on mouse-over.\n     */\n    private final CNodeHoverer m_nodeHoverer = new CNodeHoverer();\n    /**\n     * Handles proximity-browsing related updating events.\n     */\n    private final CProximityFunctions m_proximityFunctions = new CProximityFunctions();\n    @Override\n    public void addedNode(final ZyGraph graph, final NaviNode node) {\n      CNodeUpdaterInitializer.addUpdaters(m_model, node);\n    }\n    @Override\n    public void changedModel(final ZyGraph graph, final NaviNode node) {\n      CNodeUpdaterInitializer.addUpdaters(m_model, node);\n    }\n    @Override\n    public void changedView(final INaviView oldView, final INaviView newView) {\n      oldView.removeListener(m_viewListener);\n      newView.addListener(m_viewListener);\n      m_menuBar.updateGui();\n    }\n    @Override\n    public void edgeClicked(final NaviEdge edge, final MouseEvent event, final double x,\n        final double y) {\n      if (event.getButton() == MouseEvent.BUTTON3) {\n        final JPopupMenu menu = new CEdgeMenu(m_model.getParent(), m_model.getGraph(), edge);\n        menu.show(m_model.getGraph().getView(), event.getX(), event.getY());\n      }\n    }\n    @Override\n    public void nodeClicked(final NaviNode node, final MouseEvent event, final double x,\n        final double y) {\n      m_clickHandler.nodeClicked(node, event, x, y, m_codeNodeExtensions);\n    }\n    @Override\n    public void nodeHovered(final NaviNode node, final double x, final double y) {\n      m_nodeHoverer.nodeHovered(node, y);\n      m_model.getGraph().updateViews();\n    }\n    @Override\n    public void nodeLeft(final NaviNode node) {\n      if (m_nodeHoverer.clear(node)) {\n        m_model.getGraph().updateViews();\n      }\n    }\n    @SuppressWarnings(\"unchecked\")\n    @Override\n    public void proximityBrowserNodeClicked(final ZyProximityNode<?> proximityNode,\n        final MouseEvent event, final double x, final double y) {\n      if (event.getButton() == MouseEvent.BUTTON1) {\n        if (!event.isShiftDown() && !event.isControlDown()) {\n          m_proximityFunctions.showHiddenNodes(m_model.getParent(), m_model.getGraph(),\n              (ZyProximityNode<INaviViewNode>) proximityNode);\n        } else if (event.isShiftDown()) {\n          m_proximityFunctions.unhideAndSelect(m_model.getGraph(),\n              (ZyProximityNode<INaviViewNode>) proximityNode);\n        } else if (event.isControlDown()) {\n          m_proximityFunctions.unhideAndSelectOnly(m_model.getGraph(),\n              (ZyProximityNode<INaviViewNode>) proximityNode);\n        }\n      } else if (event.getButton() == MouseEvent.BUTTON3) {\n        final JPopupMenu menu =\n            new CProximityNodeMenu(m_model.getParent(), m_model.getGraph(),\n                (ZyProximityNode<INaviViewNode>) proximityNode);\n        menu.show(m_model.getGraph().getView(), event.getX(), event.getY());\n      }\n    }\n  }\n  /**\n   * Updates the displayed graph on relevant changes in the underlying view object.\n   */\n  private class InternalViewListener extends CViewListenerAdapter {\n    @Override\n    public boolean closingView(final INaviView view) {<fim_middle>// function below has no smell\n"}